<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>microscope</title>

        <!-- dependencies -->
        <script src="https://cdn.plot.ly/plotly-2.29.1.min.js" charset="utf-8"></script>
        <script src="https://cdn.jsdelivr.net/gh/slaide/web-pjs@main/p2.js" charset="utf-8"></script>

        <!-- fundamental components -->
        <script src="src/init.js"></script>
        <script src="src/docLinks.js"></script>

        <script src="src/modal.js"></script>
        <link rel="stylesheet" href="css/modal.css">

        <link rel="stylesheet" href="p/reset.css">
        <link rel="stylesheet" href="p/style.css">

        <link rel="stylesheet" href="css/basics.css">

        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/section.css">

        <link rel="stylesheet" href="css/live_view.css">

        <!-- tab component -->
        <script src="src/tab.js"></script>
        <link rel="stylesheet" href="css/tabs.css">

        <!-- tooltip component -->
        <link rel="stylesheet" href="css/tooltip.css">
        <script src="src/tooltip.js"></script>

        <!-- [grid] site selection -->
        <link rel="stylesheet" href="css/site_selection.css">
        <script src="src/site_selection.js"></script>

        <!--
            <div class="data hidden">
                <template name="tooltip">
                    <div class="tooltip-container data" p:init="bare_init_tooltip" p:init-vis="init_tooltip"></div>
                </template>
            </div>
        -->

        <!-- plot component -->
        <link rel="stylesheet" href="css/plot.css">
        <script src="src/plot.js"></script>

    </head>
    <body>
        <div id="main">
            <div id="main-view">
                <div id="view-select" class="tab-header-container data" p:init="init_tab_header(element)">
                    <div target="live-view">Live View</div>
                    <div target="grid-view">Channel View</div>
                    <div target="af-debug-panel">Laser Autofocus Debug</div>
                    <div target="low-level-config-view">Low Level Config</div>
                </div>
                <div id="view-show" class="tab-body-container">
                    <div id="live-view">
                        <div>Fluo 405 nm Ex in B06</div>
                        <div id="live-view-display" class="data plot-display"
                            p:init="plot_init(element)"
                            p:init-vis="plot_fit(element)"
                            p:on-wheel="plot_zoom(event)"
                            p:on-mousedown="plot_drag_start(event)"
                            p:on-mousemove="plot_drag_move(event)"
                            p:on-mouseup,mouseleave="plot_drag_end(event)"
                            p:on-dblclick="plot_fit(event)"
                        >
                            <img id="testme" src="/img/cells.webp" width=600 height=600 />
                            <img src="/img/cells2.webp" width=600 height=600 plot-x-min="200" plot-y-min="200" />
                        </div>
                        <script>
                            // on dom loaded, start 1s interval to fetch new image for #testme
                            document.addEventListener("DOMContentLoaded",function(){
                                let testme=document.getElementById("testme")
                                setInterval(function(){
                                    new XHR(false)
                                        .onload(function(xhr){
                                            let data=JSON.parse(xhr.responseText)
                                            let img_handle=data.img_handle
                                            
                                            testme.src="/img/get_by_handle?img_handle="+img_handle
                                        })
                                        .onerror(function(){
                                            console.error("error fetching new image")
                                        })
                                        .send("/api/img/get_latest_handle",null,method="POST")
                                },1e3)
                            })
                        </script>

                        <div id="live-view-x-axis-container">
                            <div class="data">{{PlotData.getFor(document.getElementById("live-view-display")).x_min.toFixed(2)}}</div>
                            <div class="data">{{PlotData.getFor(document.getElementById("live-view-display")).x_max.toFixed(2)}}</div>
                        </div>
                    </div>

                    <style>
                        #live-view-x-axis-container{
                            display:grid;
                            grid-template-columns: repeat(2,1fr);
                        }
                        /* push first child to the left, second child to the right */
                        #live-view-x-axis-container > *:first-child{
                            justify-self:start;
                        }
                        #live-view-x-axis-container > *:last-child{
                            justify-self:end;
                        }
                    </style>
                    <div id="grid-view">
                        <script>
                            function setGridViewCols(event){
                                let num_cols=parseInt(event.target.value)
                                document.getElementById("grid-view-container").style.setProperty("--num-cols",num_cols)
                            }
                        </script>
                        <style>
                            #grid-view-container{
                                display:grid;
                                --num-cols:3;
                                grid-template-columns: repeat(var(--num-cols),1fr);
                                grid-template-rows: repeat(4,1fr);
                                gap:0.5em;
                                /*scroll in y when content height exceeds own height */
                                overflow-y:scroll;
                                height:80vh;
                            }
                            #grid-view-container > div{
                                border:1px solid black;
                                aspect-ratio:1/1;
                            }

                            #grid-view-container > *{
                                width:100%;
                                height:100%;
                                display:grid;
                                grid-template-rows: min-content 1fr;
                            }
                        </style>
                        <script>
                            function linkPlots(element){
                                let plots=element.querySelectorAll(".plot-display")
                                let plot_data=PlotData.getFor(plots[0])
                                for(let plot_element of plots){
                                    plot_data.link(plot_element)
                                }
                            }
                        </script>
                        <div id="grid-view-container" class="data" p:init-vis="linkPlots(element)">
                            <template class="data" p:for="channel of microscope_config.channels">
                                <div id="live-view-{{channel.handle}}">
                                    <div>{{channel.name}}</div>
                                    <div class="data plot-display"
                                        p:init="plot_init(element)"
                                        p:init-vis="plot_fit(element)"
                                        p:on-wheel="plot_zoom(event)"
                                        p:on-mousedown="plot_drag_start(event)"
                                        p:on-mousemove="plot_drag_move(event)"
                                        p:on-mouseup,mouseleave="plot_drag_end(event)"
                                        p:on-dblclick="plot_fit(event)"
                                    >
                                        <img src="/img/cells.webp" width=600 height=600/>
                                        <img src="/img/cells2.webp" width=600 height=600 plot-x-min="200" plot-y-min="200"/>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <label>num columns:</label>
                        <input type="number" min="2" max="4" value="2" class="data" p:init="setGridViewCols({target:element})" p:on-input="setGridViewCols(event)">
                    </div>
                    <div id="af-debug-panel" class="data">
                        <label>exposure time [ms]</label>
                        <input type="number" min="0" max="936" value="100" step="1">
                        <label>analog gain</label>
                        <input type="number" min="0" max="24" value="0" step="1">
                        <button>snap</button>

                        <label>num images</label>
                        <input type="number" min="3" max="43" step="2" value="11">
                        <label>total delta z [um]</label>
                        <input type="number" min="10" max="1000" step="10" value="400">
                        <button>run</button>
                    </div>
                    <div id="low-level-config-view">
                        <style>
                            #low-level-config-view > div{
                                display:grid;
                                gap: 0 1em;
                                grid-template-columns: auto 1fr;
                            }
                        </style>
                        <div>
                            <script>
                                function getInputType(item){
                                    if(item.value_kind=="number"){
                                        return "number"
                                    }else if(item.value_kind=="text"){
                                        return "text"
                                    }else{
                                        throw new Error("unknown type "+item.value_kind)
                                    }
                                }
                                function itemIsRawInput(item){
                                    return item.value_kind=="number" || item.value_kind=="text"
                                }
                                function itemIsOptionInput(item){
                                    return item.value_kind=="option"
                                }
                                function itemIsAction(item){
                                    return item.value_kind=="action"
                                }
                                let machine_defaults=new XHR(false)
                                    .onload(function(xhr){
                                        let data=JSON.parse(xhr.responseText)
                                        return data
                                    })
                                    .send("/api/get_features/machine_defaults")
                            </script>

                            <script>
                                let machine_value_filter=_p.manage({value:""})
                                function match_name(name){
                                    if(machine_value_filter.value.length==0)
                                        return true;

                                    const lowercasename=name.toLowerCase()
                                    const lowercasemachine_value_filter=machine_value_filter.value.toLowerCase()
                                    const ret=lowercasename.includes(lowercasemachine_value_filter)
                                    return ret
                                }
                                let filtered_machine_defaults=_p.manage([])
                                function filter_results(){
                                    filtered_machine_defaults.splice(0,filtered_machine_defaults.length,...machine_defaults.filter((item)=>match_name(item.name)))
                                }
                            </script>
                            <label>Only display entries where name contains:</label>
                            <input type="text" class="data" p:bind="machine_value_filter.value" p:on-input="filter_results()" p:init-vis="filter_results()"/>

                            <template class="data" p:for="item of filtered_machine_defaults">
                                <label class="data">{{item.name}}</label>

                                <input p:if="!item.frozen && itemIsRawInput(item)" type="{{getInputType(item)}}" value="{{item.value}}"/>
                                <input p:if="item.frozen && itemIsRawInput(item)" type="{{getInputType(item)}}" value="{{item.value}}" disabled/>

                                <select p:if="!item.frozen && itemIsOptionInput(item)" value="{{item.value}}">
                                    <template p:for="option of item.options">
                                        <option value="{{option.handle}}">{{option.name}}</option>
                                    </template>
                                </select>
                                <select p:if="item.frozen && itemIsOptionInput(item)" value="{{item.value}}" disabled>
                                    <template p:for="option of item.options">
                                        <option value="{{option.handle}}">{{option.name}}</option>
                                    </template>
                                </select>
                                <button p:if="itemIsAction(item)"></button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- draggable separator component-->
            <link rel="stylesheet" href="css/separator.css">
            <script src="src/drag_separator.js"></script>
            <div id="main-sep" class="separator-vert data" p:on-mousedown="registerdrag(event)"></div>

            <div id="main-control">
                <div>
                    <style>
                        #control-top{
                            display:grid;
                            grid-template-columns: repeat(4,1fr);
                        }
                    </style>

                    <style>
                        #start-acquisition-container{
                            display:grid;
                        }
                    </style>
                    <div id="start-acquisition-container" class="section">
                        <p class="section-header">Start Acquisition <a class="data" href="{{docLinks.mainCameraTriggerAndPixelFormat}}" target="_blank">Help</a></p>

                        <style>
                            #acquisition-progress-bar2{
                                height:1.5em;
                                width:100%;

                                border:1px solid black;
                                border-radius:0.3em;
                                padding:0.3em;

                                --percent-done:50%;
                                background:linear-gradient(to right, #adf8c1 var(--percent-done), white var(--percent-done));
                            }
                        </style>
                        <script>
                            let progress_element=null
                            function removecontainerelement(element){
                                progress_element=element
                                element.parentElement?.removeChild(element)
                            }
                        </script>
                        <div class="data" p:init="removecontainerelement(element)" id="acquisitionprogresscontainer">
                            <div>acquisition progress:</div>
                            <div id="acquisition-progress-bar2"></div>
                        </div>
                        <script>
                            function start_acquisition(){
                                new XHR(false)
                                    .onload((xhr)=>{
                                        let acquisition_id=JSON.parse(xhr.responseText).acquisition_id
                                        
                                        let last_request=null
                                        spawnModal("Acquisition Progress",progress_element,{
                                            oninit:function(){
                                                const updateIntervalHandle=setInterval(function(){
                                                    last_request=new XHR()
                                                        .onload((xhr)=>{
                                                            if(last_request!=null && last_request.xhr!=xhr)
                                                                return;

                                                            let progress=JSON.parse(xhr.responseText)
                                                            progress_element.children[1].innerText=progress.message
                                                            progress_element.children[1].style.setProperty(
                                                                "--percent-done",
                                                                progress.acquisition_progress.current_num_images
                                                                /progress.acquisition_meta_information.total_num_images
                                                                *100
                                                                +"%"
                                                            )
                                                            
                                                            // stop polling when acquisition is done
                                                            if(progress.acquisition_progress.current_num_images==progress.acquisition_meta_information.total_num_images){
                                                                clearInterval(updateIntervalHandle)
                                                            }
                                                        })
                                                        .onerror(()=>{
                                                            console.error("error getting acquisition progress")
                                                        })
                                                        .send("/api/acquisition/status",{"acquisition_id":acquisition_id},method="POST")
                                                },1e3/15)
                                            }
                                        })
                                    })
                                    .onerror(()=>{
                                        console.error("error starting acquisition")
                                    })
                                    .send("/api/acquisition/start",{"config_file":microscope_config},method="POST")
                            }
                        </script>
                        <button id="start-acquisition-button" class="data" p:on-click="start_acquisition()">start acquisition</button>
                    </div>

                    <style>
                        #config-file-io{
                            display:grid;
                            grid-template-columns: repeat(2,1fr);
                        }
                    </style>
                    <div id="config-file-io" class="section">
                        <p class="section-header col-span-2">Save/Load configuration file</p>

                        <button>Save Configuration</button>
                        <button>Load Configuration</button>
                    </div>
                    <div>
                        <div id="control-select" class="tab-header-container data" p:init="init_tab_header(element)">
                            <div target="acquisition-control">Aquisition Control</div>
                            <div target="lighting-control">Lighting and Focus</div>
                        </div>
                        <div id="control-show" class="tab-body-container">
                            <style>
                                #acquisition-control:not(.hidden){
                                    display:grid;
                                    row-gap:0.5em;
                                }
                                #lighting-control:not(.hidden){
                                    display:grid;
                                    row-gap:0.5em;
                                }
                            </style>
                            <div id="acquisition-control">
                                <style>
                                    #path-config{
                                        display:grid;
                                        grid-template-columns: auto 1fr;
                                    }
                                </style>
                                <div id="path-config" class="section">
                                    <p class="section-header col-span-3">Image Storage Path (Output) <a class="data" href="{{docLinks.storageOutputPath}}" target="_blank">Help</a></p>

                                    <label>Project Name</label>
                                    <input class="col-span-2 data" type="text" placeholder="project name" p:bind="microscope_config.project_name">

                                    <!--label>Image Format</label>
                                    <select>
                                        <option>TIFF (compr.)</option>
                                        <option>TIFF</option>
                                    </select-->

                                    <label class="data" p:tooltip="whatever">Plate Name</label>
                                    <input class="col-span-2 data" type="text" placeholder="plate name" p:bind="microscope_config.plate_name">

                                    <label>Cell Line</label>
                                    <input class="col-span-2 data" type="text" placeholder="cell line" p:bind="microscope_config.cell_line">
                                </div>

                                <style>
                                    #grid-config{
                                        --grid-mask-size:8em;
                                        display:grid;
                                        grid-template-columns: repeat(4,auto) min-content;
                                        grid-template-rows: repeat(4,fit-content);
                                    }
                                </style>
                                <div id="grid-config" class="section">
                                    <p class="section-header col-span-5">Imaging Site Configuration (within Well) <a class="data" href="{{docLinks.siteConfig}}" target="_blank">Help</a></p>

                                    <label>num x</label>
                                    <input type="number" min="1" max="9" value="1" step="1" class="data" p:bind="microscope_config.grid.num_x" p:on-input="updateGridMask()">
                                    <label>delta x</label>
                                    <input type="number" min="0.1" max="9" value="0.9" step="0.1" class="data" p:bind="microscope_config.grid.delta_x_mm">

                                    <label>num y</label>
                                    <input type="number" min="1" max="9" value="1" step="1" class="data" p:bind="microscope_config.grid.num_y" p:on-input="updateGridMask()">
                                    <label>delta y</label>
                                    <input type="number" min="0.1" max="9" value="0.9" step="0.1" class="data" p:bind="microscope_config.grid.delta_y_mm">

                                    <label>num z</label>
                                    <input type="number" min="1" max="9" value="1" step="1" class="data" p:bind="microscope_config.grid.num_z">
                                    <label>delta z</label>
                                    <input type="number" min="0.1" max="9" value="0.9" step="0.1" class="data" p:bind="microscope_config.grid.delta_z_um">

                                    <label>num t</label>
                                    <input type="number" min="1" max="9" value="1" step="1" class="data" p:bind="microscope_config.grid.num_t">
                                    <label>delta t</label>
                                    <style>
                                        #acqusition-config-delta-t-container{
                                            display:flex;
                                            flex-direction:row;
                                        }
                                    </style>
                                    <p id="acqusition-config-delta-t-container">
                                        <input type="number" min="0" max="23" value="3" step="1" class="data" p:bind="microscope_config.grid.delta_t.h">
                                        <label>h</label>
                                        <input type="number" min="0" max="59" value="0" step="1" class="data" p:bind="microscope_config.grid.delta_t.m">
                                        <label>m</label>
                                        <input type="number" min="0" max="59" value="0" step="1" class="data" p:bind="microscope_config.grid.delta_t.s">
                                        <label>s</label>
                                    </p>

                                    <div id="site-selection" class="data" p:init="updateGridMask()">
                                        <div id="site-selection-centerer">
                                            <template p:for="row of grid_mask">
                                                <template p:for="cell of row">
                                                    <div grid-column="{{cell.col+1}}" grid-row="{{cell.row+1}}" class="{{cell.selected?'blue':''}}" p:on-click="toggleGridItem(cell)"></div>
                                                </template>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <div id="well-navigator" class="section">
                                    <p class="section-header col-span-1">Plate Well Selection <a class="data" href="{{docLinks.plateWellSelection}}" target="_blank">Help</a></p>

                                    <style>
                                        #well-navigator-header{
                                            display:grid;
                                            grid-template-columns: repeat(2,max-content);
                                        }
                                    </style>
                                    <div id="well-navigator-header">
                                        <label class="data" p:tooltip="the type of plate currently on the plate">Plate Type</label>
                                        <select class="data"
                                            p:bind="microscope_config.wellplate_type"
                                            p:on-input="initwellnavigator()"
                                        >
                                            <template class="data" p:for="plate_type of WellplateType.all">
                                                <optgroup label="{{plate_type.name}}">
                                                    <template class="data" p:for="type of plate_type.entries">
                                                        <option value="{{type.handle}}">{{type.name}}</option>
                                                    </template>
                                                </optgroup>
                                            </template>
                                        </select>
                                    </div>

                                    <link href="css/well_navigator.css" rel="stylesheet">
                                    <script src="src/well_navigator.js"></script>
                                    <div id="well-navigator-container" class="data" p:init="initwellnavigator()">
                                        <template class="data" p:for="well of plate_wells">
                                            <div p:on-dblclick="clickWell(well)">{{well.label}}</div>
                                        </template>
                                    </div>
                                </div>

                                <div class="section" id="objective-position-on-plate-container">
                                    <p class="section-header col-span-1"><b>TODO</b> objective position overview</p>
                                    <script>
                                        function initObjectivePositionObserver(element){
                                            // set height and width to maintain 12/8 aspect ratio (more wide than high)
                                            element.style.setProperty("aspect-ratio","12/8")
                                            // set width to max possible
                                            //element.style.setProperty("width","calc( 100% - 2px)")
                                            element.style.setProperty("border","1px solid black")
                                        }
                                    </script>
                                    <style>
                                        #objective-position-on-plate-container{
                                            display:grid;
                                            grid-template-columns: repeat(1,1fr);
                                        }
                                    </style>
                                    <div id="objective-position-on-plate" class="data" p:init="initObjectivePositionObserver(element)"></div>
                                </div>
                            </div>
                            <div id="lighting-control">
                                <style>
                                    #snap-selection-container{
                                        display:grid;
                                        grid-template-columns: repeat(4,auto);
                                    }
                                </style>
                                <div id="snap-selection-container" class="section">
                                    <p class="section-header col-span-4">Snap Selection Control <a class="data" href="{{docLinks.snapSelectionControl}}" target="_blank">Help</a></p>

                                    <button>snap selection</button>
                                    <button>change selection</button>
                                    <label for="snap-selection-apply-offset">apply z offset</label>
                                    <input type="checkbox" id="snap-selection-apply-offset">
                                </div>

                                <style>
                                    #all-channel-container{
                                        --width:100%;
                                    }
                                    .one-channel-container{
                                        display:grid;
                                        grid-template-columns: repeat(6,auto);
                                    }
                                </style>
                                <div id="all-channel-container" class="section">
                                    <p class="section-header col-span-6">Imaging Channel Configuration <a class="data" href="{{docLinks.imagingChannelConfig}}" target="_blank">Help</a></p>

                                    <script>
                                        function snapChannel(channel){
                                            console.log("snapping channel",channel)
                                            return;
                                            new XHR()
                                                .onload((xhr)=>{
                                                    let response=JSON.parse(xhr.responseText)
                                                    console.log(response)
                                                })
                                                .onerror(()=>{
                                                    console.error("error snapping channel")
                                                })
                                                .send("/api/action/snap_channel",{"channel":channel},method="POST")
                                        }
                                    </script>

                                    <template class="data" p:for="channel of microscope_config.channels">
                                        <div class="one-channel-container">
                                            <p class="col-span-2">{{channel.name}}</p>
                                            <button class="col-span-2" p:on-click="snapChannel(channel)">Snap</button>
                                            <label class="data" p:tooltip="hello there">Illumination (%)</label>
                                            <input type="number"
                                                min="{{limits.illumination_percent.min}}"
                                                max="{{limits.illumination_percent.max}}"
                                                value="{{limits.illumination_percent.default}}" step="0.1" class="data" p:bind="channel.illum_perc">
                                            <label>Exposure time (ms)</label>
                                            <input type="number"
                                                min="{{limits.exposure_time_ms.min}}"
                                                max="{{limits.exposure_time_ms.max}}"
                                                value="{{limits.exposure_time_ms.default}}" step="0.1" class="data" p:bind="channel.exposure_time_ms">
                                            <label>Analog Gain</label>
                                            <input type="number"
                                                min="{{limits.analog_gain.min}}"
                                                max="{{limits.analog_gain.max}}"
                                                value="{{limits.analog_gain.default}}" step="0.1" class="data" p:bind="channel.analog_gain">
                                            <label>Z Offset (um)</label>
                                            <input type="number"
                                                min="{{limits.z_offset_um.min}}"
                                                max="{{limits.z_offset_um.max}}"
                                                value="{{limits.z_offset_um.default}}" step="0.1" class="data" p:bind="channel.z_offset_um">
                                        </div>
                                    </template>
                                </div>

                                <style>
                                    #histogram-container{
                                        display:grid;
                                        grid-template-columns: repeat(4,auto);
                                    }
                                </style>
                                <div id="histogram-container" class="section">
                                    <p class="section-header col-span-4">Histogram <a class="data" href="{{docLinks.histogramPanel}}" target="_blank">Help</a></p>

                                    <div class="col-span-4">
                                        <style>
                                            #histogram-panel{
                                                height:15em;
                                            }
                                        </style>
                                        <div id="histogram-panel"></div>
                                        <script src="src/histogram.js"></script>
                                    </div>
                                    <label>view brightness</label>
                                    <input type="number" min="0" max="4" value="1" step="0.2">
                                    <label>view contrast</label>
                                    <input type="number" min="0" max="4" value="1" step="0.2">

                                    <div id="live-view-control" class="col-span-4">
                                        <button>Start Live</button>
                                        <button>Stop Live</button>

                                        <label>channel</label>
                                        <select>
                                            <template id="whatever" class="data" p:for="channel of microscope_config.channels">
                                                <option value="{{channel.handle}}">{{channel.name}}</option>
                                            </template>
                                        </select>

                                        <label class="data" p:tooltip="number of frames/images recorded per second while live">fps</label>
                                        <input type="number" min="1" max="100" value="5" step="1">
                                    </div>
                                </div>

                                <style>
                                    #objective-position{
                                        display:grid;
                                        grid-template-columns: repeat(5,1fr);
                                    }
                                </style>
                                <div id="objective-position" class="section">
                                    <p class="section-header col-span-5">Objective Position <a class="data" href="{{docLinks.objectivePositionControl}}" target="_blank">Help</a></p>

                                    <label>x (mm)</label>
                                    <p class="data">{{microscope_state.pos.x_mm.toFixed(2)}}</p>
                                    <input id="x_move_distance_mm" type="number" min="0.01" max="100" step="0.01" value="1">
                                    <script>
                                        function move_x(dist_sign){
                                            let data={}
                                            let x_move_distance_mm_el=document.getElementById("x_move_distance_mm")
                                            if(!x_move_distance_mm_el)throw new Error("element not found")

                                            data.dist_mm=dist_sign*parseFloat(x_move_distance_mm_el.value)

                                            new XHR()
                                                .onload((xhr)=>{
                                                    let response=JSON.parse(xhr.responseText)
                                                    console.log(response)
                                                })
                                                .onerror(()=>{
                                                    console.error("error moving x")
                                                })
                                                .send("/api/action/move_x_by",data,method="POST")
                                        }
                                        function forward_x(){
                                            move_x(1)
                                        }
                                        function backward_x(){
                                            move_x(-1)
                                        }

                                        function move_y(dist_sign){
                                            let data={}
                                            let y_move_distance_mm_el=document.getElementById("y_move_distance_mm")
                                            if(!y_move_distance_mm_el)throw new Error("element not found")

                                            data.dist_mm=dist_sign*parseFloat(y_move_distance_mm_el.value)

                                            new XHR()
                                                .onload((xhr)=>{
                                                    let response=JSON.parse(xhr.responseText)
                                                    console.log(response)
                                                })
                                                .onerror(()=>{
                                                    console.error("error moving y")
                                                })
                                                .send("/api/action/move_y_by",data,method="POST")
                                        }
                                        function forward_y(){
                                            move_y(1)
                                        }
                                        function backward_y(){
                                            move_y(-1)
                                        }

                                        function move_z(dist_sign){
                                            let data={}
                                            let z_move_distance_um_el=document.getElementById("z_move_distance_um")
                                            if(!z_move_distance_um_el)throw new Error("element not found")

                                            data.dist_mm=dist_sign*parseFloat(z_move_distance_um_el.value)*1e-3
                                            console.log("moving z by",data.dist_mm.toFixed(3),"mm")

                                            new XHR()
                                                .onload((xhr)=>{
                                                    let response=JSON.parse(xhr.responseText)
                                                    console.log(response)
                                                })
                                                .onerror(()=>{
                                                    console.error("error moving z")
                                                })
                                                .send("/api/action/move_z_by",data,method="POST")
                                        }
                                        function forward_z(){
                                            move_z(1)
                                        }
                                        function backward_z(){
                                            move_z(-1)
                                        }
                                    </script>
                                    <button class="data" p:on-click="forward_x()">Forward</button>
                                    <button class="data" p:on-click="backward_x()">Backward</button>

                                    <label>y (mm)</label>
                                    <p class="data">{{microscope_state.pos.y_mm.toFixed(2)}}</p>
                                    <input id="y_move_distance_mm" type="number" min="0.01" max="100" step="0.01" value="1">
                                    <button class="data" p:on-click="forward_y()">Forward</button>
                                    <button class="data" p:on-click="backward_y()">Backward</button>

                                    <label>z (um)</label>
                                    <p class="data">{{microscope_state.pos.z_um.toFixed(2)}}</p>
                                    <input id="z_move_distance_um" type="number" min="0.01" max="100" step="0.01" value="1">
                                    <button class="data" p:on-click="forward_z()">Forward</button>
                                    <button class="data" p:on-click="backward_z()">Backward</button>

                                    <button>Zero Z</button>
                                    <script>
                                        function enterLoadingPosition(){
                                            new XHR(true)
                                                .onload(function(xhr){
                                                    console.log("left loading position")
                                                })
                                                .onerror(function(){
                                                    console.error("error entering loading position")
                                                })
                                                .send("/api/action/enter_loading_position",null,"POST")
                                        }
                                        function leaveLoadingPosition(){
                                            new XHR(true)
                                                .onload(function(xhr){
                                                    console.log("left loading position")
                                                })
                                                .onerror(function(){
                                                    console.error("error entering loading position")
                                                })
                                                .send("/api/action/leave_loading_position",null,"POST")
                                        }
                                    </script>
                                    <button class="col-span-2 data" p:on-click="enterLoadingPosition()">enter loading position</button>
                                    <button class="col-span-2 data" p:on-click="leaveLoadingPosition()">leave loading position</button>
                                </div>

                                <style>
                                    #laser-autofocus-config{
                                        display:grid;
                                        grid-template-columns: repeat(3,1fr);
                                    }
                                </style>
                                <div id="laser-autofocus-config" class="section">
                                    <p class="section-header col-span-3">Laser Reflection Autofocus <a class="data" href="{{docLinks.laserReflectionAutofocusControl}}" target="_blank">Help</a></p>

                                    <button>Initialize</button>
                                    <button>Go to reference</button>
                                    <button>Set as reference</button>
                                    <label>measured offset (um)</label>
                                    <p>-97.24</p>
                                    <button>Measure offset</button>
                                    <label>z offset target (um)</label>
                                    <input type="number" min="-100" max="100" value="0" step="0.1">
                                    <button>go to target</button>
                                </div>

                                <style>
                                    #software-autofocus-controls{
                                        display:grid;
                                        grid-template-columns: repeat(6,1fr);
                                    }
                                </style>
                                <div id="software-autofocus-controls" class="section">
                                    <p class="section-header col-span-6">Software Autofocus <a class="data" href="{{docLinks.softwareAutofocusControl}}" target="_blank">Help</a></p>

                                    <label>delta z (um)</label>
                                    <input type="number" min="0.1" max="100" value="0.9" step="0.1">

                                    <label>num images</label>
                                    <input type="number" min="3" max="100" value="11" step="2">
                                    <select>
                                        <template class="data" p:for="channel of microscope_config.channels">
                                            <option value="{{channel.handle}}">{{channel.name}}</option>
                                        </template>
                                    </select>
                                    <button>Run</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>